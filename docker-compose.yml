version: '3.9'

# Single source of truth: edit .env at the project root.
#
#   HOST_IP        - IP/hostname where the backend is reachable from browsers
#                    (your LAN IP, a domain name, or 127.0.0.1 for local-only)
#   BACKEND_PORT   - port the FastAPI server listens on  (default: 7001)
#   FRONTEND_PORT  - external port mapped to frontend container (default: 80)
#   ADMIN_USERNAME - username for theme/portfolio save    (default: admin)
#   ADMIN_PASSWORD - password for theme/portfolio save    (default: admin)
#   GEMINI_API_KEY / OPENAI_API_KEY / ANTHROPIC_API_KEY  - LLM keys

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - BACKEND_PORT=${BACKEND_PORT:-7001}
      - PORTFOLIO_PUBLIC_DIR=/portfolio-public
      - DATA_DIR=/app/data
    expose:
      - "7001"
    volumes:
      - ./backend/data:/app/data
      - ./my-portfolio/public:/portfolio-public
    command: >
      poetry run uvicorn main:app
      --host 0.0.0.0
      --port ${BACKEND_PORT:-7001}
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_WS_BACKEND_URL=ws://backend:7001
        - VITE_HTTP_BACKEND_URL=http://backend:7001
    expose:
      - "5173"
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/certs:/etc/letsencrypt
      - ./nginx/www:/var/www/certbot
    depends_on:
      - frontend
      - backend
    restart: unless-stopped